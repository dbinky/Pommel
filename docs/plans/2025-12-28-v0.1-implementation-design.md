# Pommel v0.1 Implementation Design

**Date:** 2025-12-28
**Status:** Ready for Implementation
**Related:** [PROJECT_BRIEF.md](./PROJECT_BRIEF.md)

---

## Table of Contents

1. [Technology Stack](#technology-stack)
2. [Project Structure](#project-structure)
3. [Component Architecture](#component-architecture)
4. [Data Models](#data-models)
5. [REST API Specification](#rest-api-specification)
6. [Dependency Management](#dependency-management)
7. [Implementation Phases](#implementation-phases)
8. [Detailed Task Breakdown](#detailed-task-breakdown)

---

## Technology Stack

| Component | Technology | Version/Package |
|-----------|------------|-----------------|
| Language | Go | 1.21+ |
| Vector Database | sqlite-vec | `github.com/asg017/sqlite-vec-go-bindings/ncruces` (WASM) |
| SQLite Driver | ncruces/go-sqlite3 | `github.com/ncruces/go-sqlite3` |
| Embedding Runtime | Ollama | System install |
| Embedding Model | Jina Code v2 | `unclemusclez/jina-embeddings-v2-base-code` |
| AST Parsing | Tree-sitter | `github.com/smacker/go-tree-sitter` |
| CLI Framework | Cobra | `github.com/spf13/cobra` |
| Configuration | Viper | `github.com/spf13/viper` |
| File Watching | fsnotify | `github.com/fsnotify/fsnotify` |
| HTTP Router | Chi | `github.com/go-chi/chi/v5` |
| Logging | slog | Standard library (Go 1.21+) |
| Testing | testify | `github.com/stretchr/testify` |

---

## Project Structure

```
pommel/
├── cmd/
│   ├── pm/                    # CLI binary
│   │   └── main.go
│   └── pommeld/               # Daemon binary
│       └── main.go
├── internal/
│   ├── api/                   # REST API handlers
│   │   ├── router.go
│   │   ├── handlers.go
│   │   ├── middleware.go
│   │   └── responses.go
│   ├── chunker/               # Code chunking logic
│   │   ├── chunker.go         # Interface and orchestration
│   │   ├── treesitter.go      # Tree-sitter integration
│   │   ├── csharp.go          # C# language rules
│   │   ├── python.go          # Python language rules
│   │   ├── javascript.go      # JavaScript/TypeScript rules
│   │   └── fallback.go        # Line-based fallback
│   ├── cli/                   # CLI commands
│   │   ├── root.go
│   │   ├── init.go
│   │   ├── search.go
│   │   ├── start.go
│   │   ├── stop.go
│   │   ├── status.go
│   │   ├── reindex.go
│   │   └── config.go
│   ├── config/                # Configuration loading
│   │   ├── config.go
│   │   └── defaults.go
│   ├── daemon/                # Daemon orchestration
│   │   ├── daemon.go
│   │   ├── watcher.go
│   │   ├── indexer.go
│   │   └── state.go
│   ├── db/                    # Database layer
│   │   ├── sqlite.go          # SQLite connection
│   │   ├── schema.go          # Schema migrations
│   │   ├── chunks.go          # Chunk CRUD operations
│   │   └── search.go          # Vector search queries
│   ├── embedder/              # Embedding generation
│   │   ├── embedder.go        # Interface
│   │   ├── ollama.go          # Ollama client
│   │   └── cache.go           # Query embedding cache
│   ├── models/                # Shared data structures
│   │   ├── chunk.go
│   │   ├── file.go
│   │   └── search.go
│   └── setup/                 # Dependency detection/setup
│       ├── detector.go
│       ├── ollama.go
│       └── model.go
├── pkg/                       # Public packages (if needed)
│   └── client/                # Go client for daemon API
│       └── client.go
├── testdata/                  # Test fixtures
│   ├── csharp/
│   ├── python/
│   ├── javascript/
│   └── typescript/
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

---

## Component Architecture

### Overview

```
┌──────────────────────────────────────────────────────────────────────┐
│                           USER / AGENT                               │
└────────────────────────────────┬─────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         CLI (pm binary)                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│  │  init   │ │ search  │ │ status  │ │ start   │ │  stop   │ ...    │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘        │
│       │           │           │           │           │              │
│       ▼           ▼           ▼           ▼           ▼              │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                     HTTP Client                               │   │
│  │              (calls daemon REST API)                          │   │
│  └──────────────────────────────────────────────────────────────┘   │
└────────────────────────────────┬─────────────────────────────────────┘
                                 │ HTTP (localhost:7420)
                                 ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      DAEMON (pommeld binary)                         │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                      REST API Server                          │   │
│  │  /search  /status  /health  /reindex  /config                 │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                 │                                    │
│       ┌─────────────────────────┼─────────────────────────┐         │
│       ▼                         ▼                         ▼         │
│  ┌─────────────┐        ┌─────────────┐          ┌─────────────┐   │
│  │   Watcher   │        │   Indexer   │          │   Searcher  │   │
│  │  (fsnotify) │───────►│  (chunker   │          │  (embedder  │   │
│  │             │        │   +embed)   │          │   +sqlite)  │   │
│  └─────────────┘        └──────┬──────┘          └──────┬──────┘   │
│                                │                        │           │
│                                ▼                        ▼           │
│                       ┌─────────────────────────────────────┐       │
│                       │           sqlite-vec DB             │       │
│                       │         (.pommel/index.db)          │       │
│                       └─────────────────────────────────────┘       │
│                                        │                            │
│                                        ▼                            │
│                       ┌─────────────────────────────────────┐       │
│                       │             Ollama                   │       │
│                       │    (jina-embeddings-v2-base-code)   │       │
│                       └─────────────────────────────────────┘       │
└──────────────────────────────────────────────────────────────────────┘
```

### Daemon Components

#### 1. Watcher (`internal/daemon/watcher.go`)

Responsibilities:
- Monitor project directory using fsnotify
- Respect `.pommelignore` and `.gitignore` patterns
- Debounce rapid file changes (configurable, default 500ms)
- Queue changed files for indexing
- Handle file create, modify, delete, rename events

Key interfaces:
```go
type Watcher interface {
    Start(ctx context.Context) error
    Stop() error
    Events() <-chan FileEvent
}

type FileEvent struct {
    Path      string
    Operation Operation // Create, Modify, Delete, Rename
    Timestamp time.Time
}
```

#### 2. Indexer (`internal/daemon/indexer.go`)

Responsibilities:
- Process file events from watcher
- Coordinate chunking and embedding
- Update database (add, update, delete chunks)
- Track indexing progress and statistics

Key interfaces:
```go
type Indexer interface {
    IndexFile(ctx context.Context, path string) error
    DeleteFile(ctx context.Context, path string) error
    ReindexAll(ctx context.Context) error
    Stats() IndexStats
}

type IndexStats struct {
    TotalFiles      int
    TotalChunks     int
    LastIndexedAt   time.Time
    PendingFiles    int
    IndexingActive  bool
}
```

#### 3. Chunker (`internal/chunker/`)

Responsibilities:
- Parse source files using Tree-sitter
- Extract chunks at file, class, and method levels
- Maintain parent-child relationships between chunks
- Provide contextual preamble for each chunk

Key interfaces:
```go
type Chunker interface {
    Chunk(ctx context.Context, file *SourceFile) ([]Chunk, error)
    SupportedLanguages() []string
}

type Chunk struct {
    ID            string
    FilePath      string
    StartLine     int
    EndLine       int
    Level         ChunkLevel // File, Class, Method
    Language      string
    Content       string
    ParentID      *string
    Name          string     // Function/class name
    Signature     string     // For methods: full signature
}

type ChunkLevel string
const (
    ChunkLevelFile   ChunkLevel = "file"
    ChunkLevelClass  ChunkLevel = "class"
    ChunkLevelMethod ChunkLevel = "method"
)
```

#### 4. Embedder (`internal/embedder/`)

Responsibilities:
- Interface with Ollama for embedding generation
- Batch embedding requests for efficiency
- Cache query embeddings to avoid redundant calls
- Handle Ollama availability and errors

Key interfaces:
```go
type Embedder interface {
    Embed(ctx context.Context, texts []string) ([][]float32, error)
    EmbedSingle(ctx context.Context, text string) ([]float32, error)
    ModelName() string
    Dimensions() int
}
```

#### 5. Database (`internal/db/`)

Responsibilities:
- Manage sqlite-vec connection and schema
- CRUD operations for chunks
- Vector similarity search
- WAL mode for concurrent access

Key interfaces:
```go
type Database interface {
    // Chunk operations
    InsertChunks(ctx context.Context, chunks []ChunkRecord) error
    DeleteChunksByFile(ctx context.Context, filePath string) error
    GetChunk(ctx context.Context, id string) (*ChunkRecord, error)

    // Search
    Search(ctx context.Context, query SearchQuery) ([]SearchResult, error)

    // Stats
    Stats(ctx context.Context) (*DBStats, error)

    // Lifecycle
    Close() error
}

type ChunkRecord struct {
    ID          string
    FilePath    string
    StartLine   int
    EndLine     int
    Level       string
    Language    string
    Content     string
    ParentID    *string
    Name        string
    Embedding   []float32
    ContentHash string
    LastModified time.Time
}

type SearchQuery struct {
    Embedding  []float32
    Limit      int
    Levels     []string  // Filter by chunk level
    PathPrefix string    // Filter by path
}

type SearchResult struct {
    Chunk ChunkRecord
    Score float32
}
```

---

## Data Models

### Database Schema

```sql
-- Enable WAL mode for concurrent access
PRAGMA journal_mode = WAL;

-- Main chunks table
CREATE TABLE IF NOT EXISTS chunks (
    id TEXT PRIMARY KEY,
    file_path TEXT NOT NULL,
    start_line INTEGER NOT NULL,
    end_line INTEGER NOT NULL,
    level TEXT NOT NULL CHECK (level IN ('file', 'class', 'method')),
    language TEXT NOT NULL,
    content TEXT NOT NULL,
    parent_id TEXT REFERENCES chunks(id) ON DELETE SET NULL,
    name TEXT,
    content_hash TEXT NOT NULL,
    last_modified TEXT NOT NULL,  -- ISO 8601
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes for common queries
CREATE INDEX IF NOT EXISTS idx_chunks_file_path ON chunks(file_path);
CREATE INDEX IF NOT EXISTS idx_chunks_level ON chunks(level);
CREATE INDEX IF NOT EXISTS idx_chunks_parent_id ON chunks(parent_id);
CREATE INDEX IF NOT EXISTS idx_chunks_content_hash ON chunks(content_hash);

-- Virtual table for vector search (sqlite-vec)
CREATE VIRTUAL TABLE IF NOT EXISTS chunk_embeddings USING vec0(
    chunk_id TEXT PRIMARY KEY,
    embedding FLOAT[768]
);

-- Files table for tracking indexed files
CREATE TABLE IF NOT EXISTS files (
    path TEXT PRIMARY KEY,
    content_hash TEXT NOT NULL,
    last_modified TEXT NOT NULL,
    last_indexed TEXT NOT NULL,
    chunk_count INTEGER NOT NULL DEFAULT 0
);

-- Metadata table for schema version, etc.
CREATE TABLE IF NOT EXISTS metadata (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);

-- Initialize schema version
INSERT OR IGNORE INTO metadata (key, value) VALUES ('schema_version', '1');
```

### Configuration Schema (`config.yaml`)

```yaml
# .pommel/config.yaml
version: 1

# Chunk levels to generate
chunk_levels:
  - method
  - class
  - file

# File patterns to include
include_patterns:
  - "**/*.cs"
  - "**/*.py"
  - "**/*.js"
  - "**/*.ts"
  - "**/*.jsx"
  - "**/*.tsx"

# Patterns to exclude (in addition to .pommelignore)
exclude_patterns:
  - "**/node_modules/**"
  - "**/bin/**"
  - "**/obj/**"
  - "**/__pycache__/**"
  - "**/.git/**"

# File watcher settings
watcher:
  debounce_ms: 500
  max_file_size: 1048576  # 1MB

# Daemon settings
daemon:
  host: "127.0.0.1"
  port: 7420
  log_level: "info"  # debug, info, warn, error

# Embedding settings
embedding:
  model: "unclemusclez/jina-embeddings-v2-base-code"
  batch_size: 32
  cache_size: 1000  # Number of query embeddings to cache

# Search defaults
search:
  default_limit: 10
  default_levels:
    - method
    - class
```

### State File (`state.json`)

```json
{
  "version": 1,
  "daemon": {
    "pid": 12345,
    "started_at": "2025-12-28T10:30:00Z",
    "port": 7420
  },
  "index": {
    "last_full_index": "2025-12-28T10:30:00Z",
    "total_files": 150,
    "total_chunks": 2340
  }
}
```

---

## REST API Specification

Base URL: `http://127.0.0.1:7420`

### POST /search

Semantic search across indexed code.

**Request:**
```json
{
  "query": "authentication middleware",
  "limit": 10,
  "levels": ["method", "class"],
  "path_prefix": "src/"
}
```

**Response (200):**
```json
{
  "query": "authentication middleware",
  "results": [
    {
      "id": "a1b2c3d4e5f6",
      "file": "src/auth/middleware.py",
      "start_line": 15,
      "end_line": 45,
      "level": "method",
      "language": "python",
      "name": "authenticate_request",
      "score": 0.892,
      "content": "def authenticate_request(request):\n    ...",
      "parent": {
        "id": "p1q2r3s4",
        "name": "AuthMiddleware",
        "level": "class"
      }
    }
  ],
  "total_results": 15,
  "search_time_ms": 42
}
```

### GET /status

Get daemon and index status.

**Response (200):**
```json
{
  "daemon": {
    "running": true,
    "pid": 12345,
    "uptime_seconds": 3600,
    "version": "0.1.0"
  },
  "index": {
    "total_files": 150,
    "total_chunks": 2340,
    "last_indexed": "2025-12-28T10:30:00Z",
    "pending_changes": 0,
    "indexing_active": false
  },
  "dependencies": {
    "ollama": {
      "status": "running",
      "model_loaded": true,
      "model": "unclemusclez/jina-embeddings-v2-base-code"
    },
    "database": {
      "status": "connected",
      "size_bytes": 15728640,
      "wal_size_bytes": 1048576
    }
  }
}
```

### GET /health

Simple health check for monitoring.

**Response (200):**
```json
{
  "status": "healthy",
  "timestamp": "2025-12-28T10:30:00Z"
}
```

**Response (503):**
```json
{
  "status": "unhealthy",
  "reason": "ollama not responding",
  "timestamp": "2025-12-28T10:30:00Z"
}
```

### POST /reindex

Trigger a full reindex of the project.

**Request:**
```json
{
  "force": false
}
```

**Response (202):**
```json
{
  "status": "started",
  "message": "Reindex started in background"
}
```

### GET /config

Get current configuration.

**Response (200):**
```json
{
  "chunk_levels": ["method", "class", "file"],
  "include_patterns": ["**/*.py", "**/*.js"],
  "daemon": {
    "port": 7420,
    "log_level": "info"
  }
}
```

### Error Responses

All errors follow this format:

```json
{
  "error": {
    "code": "OLLAMA_NOT_RUNNING",
    "message": "Ollama service is not running",
    "details": "Start Ollama with: ollama serve"
  }
}
```

Error codes:
- `OLLAMA_NOT_RUNNING` - Ollama service not available
- `MODEL_NOT_LOADED` - Embedding model not pulled
- `DATABASE_ERROR` - sqlite-vec error
- `INDEXING_IN_PROGRESS` - Cannot perform operation while indexing
- `INVALID_REQUEST` - Malformed request body
- `NOT_INITIALIZED` - Project not initialized with `pm init`

---

## Dependency Management

### Auto-Setup Flow (`pm init`)

```
┌─────────────────────────────────────────────────────────────────┐
│                         pm init                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  Check for .pommel/    │
                    │  directory exists      │
                    └───────────┬────────────┘
                                │
            ┌───────────────────┼───────────────────┐
            ▼                                       ▼
    ┌───────────────┐                      ┌───────────────┐
    │ Already init  │                      │ Create        │
    │ Show warning  │                      │ .pommel/      │
    └───────────────┘                      └───────┬───────┘
                                                   │
                                                   ▼
                                   ┌───────────────────────────┐
                                   │  Detect Ollama installed  │
                                   └───────────────┬───────────┘
                                                   │
                    ┌──────────────────────────────┼──────────────────────────────┐
                    ▼                              ▼                              ▼
           ┌───────────────┐             ┌───────────────┐              ┌───────────────┐
           │ Not installed │             │ Installed but │              │ Running with  │
           │ Prompt install│             │ not running   │              │ model ready   │
           └───────┬───────┘             │ Auto-start    │              │ Continue      │
                   │                     └───────┬───────┘              └───────┬───────┘
                   ▼                             │                              │
           ┌───────────────┐                     │                              │
           │ brew install  │                     │                              │
           │ ollama        │                     │                              │
           └───────┬───────┘                     │                              │
                   │                             │                              │
                   └─────────────────────────────┼──────────────────────────────┘
                                                 │
                                                 ▼
                                   ┌───────────────────────────┐
                                   │  Check model pulled       │
                                   └───────────────┬───────────┘
                                                   │
                            ┌──────────────────────┼──────────────────────┐
                            ▼                                             ▼
                   ┌───────────────┐                             ┌───────────────┐
                   │ Model missing │                             │ Model ready   │
                   │ ollama pull   │                             │ Continue      │
                   └───────┬───────┘                             └───────┬───────┘
                           │                                             │
                           └─────────────────────┬───────────────────────┘
                                                 │
                                                 ▼
                                   ┌───────────────────────────┐
                                   │  Create config.yaml       │
                                   │  Create state.json        │
                                   │  Initialize index.db      │
                                   └───────────────┬───────────┘
                                                   │
                                                   ▼
                                   ┌───────────────────────────┐
                                   │  --claude flag?           │
                                   └───────────────┬───────────┘
                                                   │
                            ┌──────────────────────┼──────────────────────┐
                            ▼                                             ▼
                   ┌───────────────┐                             ┌───────────────┐
                   │ Yes: Inject   │                             │ No: Skip      │
                   │ into CLAUDE.md│                             │               │
                   └───────────────┘                             └───────────────┘
                                                   │
                                                   ▼
                                   ┌───────────────────────────┐
                                   │  --start flag?            │
                                   │  If yes: start daemon     │
                                   └───────────────────────────┘
```

---

## Implementation Phases

### Phase 1: Foundation (Core Infrastructure)

Establish the project structure, build system, and basic components.

**Goals:**
- Project compiles and runs
- Configuration loading works
- Database initializes with schema
- Basic CLI structure in place

**Deliverables:**
- Go module initialized
- Makefile with build/test targets
- Config loading from YAML
- SQLite + sqlite-vec connection
- CLI skeleton with `pm version`

### Phase 2: Embedding Pipeline

Integrate Ollama and build the embedding infrastructure.

**Goals:**
- Connect to Ollama API
- Generate embeddings for text
- Store embeddings in sqlite-vec
- Query embedding cache

**Deliverables:**
- Ollama client with health checks
- Embedding generation with batching
- Query cache (LRU)
- sqlite-vec insert and query

### Phase 3: Chunking Engine

Build the Tree-sitter based chunking system.

**Goals:**
- Parse C#, Python, JS, TS files
- Extract file/class/method chunks
- Maintain parent-child hierarchy
- Generate chunk IDs

**Deliverables:**
- Tree-sitter integration
- Language-specific chunk extractors
- Chunk data model with hierarchy
- Fallback line-based chunker

### Phase 4: Daemon Core

Build the long-running daemon with file watching.

**Goals:**
- File watcher with debouncing
- Incremental indexing on file changes
- REST API server
- State management (PID file, etc.)

**Deliverables:**
- fsnotify integration
- Debounce logic
- Indexer coordinator
- Chi HTTP server
- API endpoints (status, health)

### Phase 5: Search Implementation

Build the search functionality end-to-end.

**Goals:**
- Embed query text
- Vector similarity search
- Result ranking and filtering
- Parent context enrichment

**Deliverables:**
- Search API endpoint
- Query processing pipeline
- Result formatting with parent info
- Path and level filtering

### Phase 6: CLI Commands

Complete all CLI commands.

**Goals:**
- All commands functional
- JSON output mode
- Error handling and messaging
- --claude flag integration

**Deliverables:**
- `pm init` with dependency checks
- `pm start` / `pm stop`
- `pm search` with filters
- `pm status`
- `pm reindex`
- `pm config`

### Phase 7: Polish & Testing

Comprehensive testing and polish.

**Goals:**
- Unit tests for all components
- Integration tests for full flows
- Error handling improvements
- Documentation

**Deliverables:**
- Test coverage > 80%
- README with usage examples
- Error messages improved
- Edge case handling

---

## Detailed Task Breakdown

### Phase 1: Foundation

#### 1.1 Project Setup
- [ ] Initialize Go module (`go mod init github.com/user/pommel`)
- [ ] Create directory structure as specified
- [ ] Create Makefile with targets: `build`, `test`, `lint`, `clean`
- [ ] Add `.gitignore` for Go projects
- [ ] Create `cmd/pm/main.go` entry point
- [ ] Create `cmd/pommeld/main.go` entry point

#### 1.2 Configuration
- [ ] Define config structs in `internal/config/config.go`
- [ ] Implement config loading with Viper
- [ ] Define default values in `internal/config/defaults.go`
- [ ] Add config validation
- [ ] Write unit tests for config loading

#### 1.3 Database Setup
- [ ] Create `internal/db/sqlite.go` with connection management
- [ ] Implement schema in `internal/db/schema.go`
- [ ] Add WAL mode configuration
- [ ] Integrate sqlite-vec extension
- [ ] Create migration runner
- [ ] Write unit tests for schema creation

#### 1.4 CLI Skeleton
- [ ] Set up Cobra root command
- [ ] Add `pm version` command
- [ ] Add global flags (`--json`, `--verbose`)
- [ ] Create output formatter for JSON mode

### Phase 2: Embedding Pipeline

#### 2.1 Ollama Client
- [ ] Create `internal/embedder/ollama.go`
- [ ] Implement HTTP client for Ollama API
- [ ] Add `/api/embeddings` endpoint integration
- [ ] Implement health check (ping Ollama)
- [ ] Add model availability check
- [ ] Handle connection errors gracefully
- [ ] Write unit tests with mock HTTP server

#### 2.2 Embedding Interface
- [ ] Define `Embedder` interface in `internal/embedder/embedder.go`
- [ ] Implement batch embedding (multiple texts)
- [ ] Add configurable batch size
- [ ] Handle rate limiting / backpressure
- [ ] Write integration tests with real Ollama

#### 2.3 Query Cache
- [ ] Create `internal/embedder/cache.go`
- [ ] Implement LRU cache for query embeddings
- [ ] Add configurable cache size
- [ ] Add cache hit/miss metrics
- [ ] Write unit tests for cache behavior

#### 2.4 Vector Storage
- [ ] Implement `InsertChunks` in `internal/db/chunks.go`
- [ ] Use sqlite-vec `SerializeFloat32` for embeddings
- [ ] Implement bulk insert for efficiency
- [ ] Add transaction handling
- [ ] Write unit tests for insert operations

### Phase 3: Chunking Engine

#### 3.1 Tree-sitter Integration
- [ ] Create `internal/chunker/treesitter.go`
- [ ] Initialize Tree-sitter parsers per language
- [ ] Create language detection by file extension
- [ ] Handle parser errors gracefully
- [ ] Write unit tests for parser initialization

#### 3.2 Chunk Data Model
- [ ] Define `Chunk` struct in `internal/models/chunk.go`
- [ ] Implement chunk ID generation (deterministic hash)
- [ ] Add content hash for change detection
- [ ] Define `ChunkLevel` enum
- [ ] Write unit tests for ID generation

#### 3.3 C# Chunker
- [ ] Create `internal/chunker/csharp.go`
- [ ] Extract namespace/class/struct chunks
- [ ] Extract method/property chunks
- [ ] Build parent-child relationships
- [ ] Include contextual preamble (class name in method)
- [ ] Write unit tests with C# fixtures

#### 3.4 Python Chunker
- [ ] Create `internal/chunker/python.go`
- [ ] Extract module-level (file) chunks
- [ ] Extract class chunks
- [ ] Extract function/method chunks
- [ ] Handle nested classes/functions
- [ ] Write unit tests with Python fixtures

#### 3.5 JavaScript/TypeScript Chunker
- [ ] Create `internal/chunker/javascript.go`
- [ ] Extract class chunks (ES6 classes)
- [ ] Extract function chunks (declarations, expressions, arrows)
- [ ] Handle TypeScript-specific constructs (interfaces, types)
- [ ] Handle JSX/TSX files
- [ ] Write unit tests with JS/TS fixtures

#### 3.6 Fallback Chunker
- [ ] Create `internal/chunker/fallback.go`
- [ ] Implement line-group based chunking
- [ ] Add file-level chunk for unsupported languages
- [ ] Write unit tests

#### 3.7 Chunker Orchestration
- [ ] Create `internal/chunker/chunker.go` interface
- [ ] Implement language router
- [ ] Add chunk validation
- [ ] Write integration tests across languages

### Phase 4: Daemon Core

#### 4.1 File Watcher
- [ ] Create `internal/daemon/watcher.go`
- [ ] Integrate fsnotify
- [ ] Implement debouncing with configurable delay
- [ ] Parse `.pommelignore` patterns
- [ ] Parse `.gitignore` patterns
- [ ] Handle recursive directory watching
- [ ] Filter events by include/exclude patterns
- [ ] Write unit tests with temp directories

#### 4.2 Indexer
- [ ] Create `internal/daemon/indexer.go`
- [ ] Implement `IndexFile` method
- [ ] Implement `DeleteFile` method (remove chunks)
- [ ] Implement `ReindexAll` method
- [ ] Add progress tracking
- [ ] Handle concurrent file events
- [ ] Write integration tests

#### 4.3 State Management
- [ ] Create `internal/daemon/state.go`
- [ ] Implement PID file creation/cleanup
- [ ] Save/load state.json
- [ ] Add graceful shutdown handling
- [ ] Write unit tests

#### 4.4 REST API Server
- [ ] Create `internal/api/router.go` with Chi
- [ ] Add middleware: logging, recovery, CORS
- [ ] Create `internal/api/handlers.go`
- [ ] Implement `/health` endpoint
- [ ] Implement `/status` endpoint
- [ ] Add request validation middleware
- [ ] Write unit tests for handlers

#### 4.5 Daemon Orchestration
- [ ] Create `internal/daemon/daemon.go`
- [ ] Wire together watcher, indexer, API server
- [ ] Implement startup sequence
- [ ] Implement shutdown sequence
- [ ] Add signal handling (SIGINT, SIGTERM)
- [ ] Write integration tests

### Phase 5: Search Implementation

#### 5.1 Vector Search
- [ ] Implement `Search` in `internal/db/search.go`
- [ ] Use sqlite-vec `vec_distance_L2` or cosine
- [ ] Add limit parameter
- [ ] Add level filtering
- [ ] Add path prefix filtering
- [ ] Optimize query for performance
- [ ] Write unit tests

#### 5.2 Parent Context
- [ ] Fetch parent chunk for each result
- [ ] Include parent info in response
- [ ] Handle orphaned chunks (deleted parent)
- [ ] Write unit tests

#### 5.3 Search API
- [ ] Implement `/search` endpoint
- [ ] Parse request body
- [ ] Embed query text (with cache)
- [ ] Execute vector search
- [ ] Format response with parent context
- [ ] Write integration tests

### Phase 6: CLI Commands

#### 6.1 Init Command
- [ ] Create `internal/cli/init.go`
- [ ] Check for existing .pommel directory
- [ ] Create directory structure
- [ ] Generate default config.yaml
- [ ] Implement dependency detection (`internal/setup/detector.go`)
- [ ] Implement Ollama detection/installation prompt
- [ ] Implement model pull prompt
- [ ] Implement `--start` flag (auto-start daemon)
- [ ] Implement `--claude` flag (inject into CLAUDE.md)
- [ ] Write unit and integration tests

#### 6.2 Start Command
- [ ] Create `internal/cli/start.go`
- [ ] Check for existing daemon (PID file)
- [ ] Fork daemon process
- [ ] Wait for health check
- [ ] Report status to user
- [ ] Handle errors (port in use, etc.)
- [ ] Write integration tests

#### 6.3 Stop Command
- [ ] Create `internal/cli/stop.go`
- [ ] Read PID from state file
- [ ] Send SIGTERM to daemon
- [ ] Wait for graceful shutdown
- [ ] Force kill after timeout
- [ ] Clean up PID file
- [ ] Write integration tests

#### 6.4 Search Command
- [ ] Create `internal/cli/search.go`
- [ ] Parse query argument
- [ ] Add `--limit` flag
- [ ] Add `--level` flag
- [ ] Add `--path` flag
- [ ] Add `--json` flag
- [ ] Call daemon API
- [ ] Format output (human-readable or JSON)
- [ ] Write integration tests

#### 6.5 Status Command
- [ ] Create `internal/cli/status.go`
- [ ] Call daemon `/status` endpoint
- [ ] Handle daemon not running
- [ ] Format output (human-readable or JSON)
- [ ] Write integration tests

#### 6.6 Reindex Command
- [ ] Create `internal/cli/reindex.go`
- [ ] Call daemon `/reindex` endpoint
- [ ] Add `--force` flag
- [ ] Show progress (poll status)
- [ ] Write integration tests

#### 6.7 Config Command
- [ ] Create `internal/cli/config.go`
- [ ] Implement `pm config` (show all)
- [ ] Implement `pm config get <key>`
- [ ] Implement `pm config set <key> <value>`
- [ ] Validate configuration changes
- [ ] Write unit tests

### Phase 7: Polish & Testing

#### 7.1 Unit Tests
- [ ] Achieve 80%+ coverage for internal packages
- [ ] Add table-driven tests where appropriate
- [ ] Mock external dependencies (Ollama, filesystem)

#### 7.2 Integration Tests
- [ ] Create `testdata/` fixtures for each language
- [ ] Test full indexing flow
- [ ] Test search with various queries
- [ ] Test daemon lifecycle
- [ ] Test CLI commands end-to-end

#### 7.3 Error Handling
- [ ] Review all error messages for clarity
- [ ] Add actionable suggestions in errors
- [ ] Ensure consistent error format in API
- [ ] Test error scenarios

#### 7.4 Documentation
- [ ] Write README.md with installation and usage
- [ ] Document all CLI commands
- [ ] Document configuration options
- [ ] Add examples for common workflows

#### 7.5 Performance
- [ ] Benchmark embedding throughput
- [ ] Benchmark search latency
- [ ] Optimize hot paths if needed
- [ ] Add metrics/timing to logs

---

## Appendix: Test Fixtures

### C# (`testdata/csharp/`)

```csharp
// AuthService.cs
namespace MyApp.Services
{
    public class AuthService
    {
        public bool ValidateToken(string token)
        {
            // Validation logic
            return !string.IsNullOrEmpty(token);
        }

        public User GetUserFromToken(string token)
        {
            // Decode and fetch user
            return new User();
        }
    }
}
```

### Python (`testdata/python/`)

```python
# auth_service.py
class AuthService:
    def validate_token(self, token: str) -> bool:
        """Validate the authentication token."""
        return bool(token)

    def get_user_from_token(self, token: str) -> dict:
        """Decode token and return user info."""
        return {"id": 1, "name": "test"}
```

### JavaScript (`testdata/javascript/`)

```javascript
// authService.js
class AuthService {
    validateToken(token) {
        return Boolean(token);
    }

    getUserFromToken(token) {
        return { id: 1, name: 'test' };
    }
}

module.exports = AuthService;
```

### TypeScript (`testdata/typescript/`)

```typescript
// authService.ts
interface User {
    id: number;
    name: string;
}

class AuthService {
    validateToken(token: string): boolean {
        return Boolean(token);
    }

    getUserFromToken(token: string): User {
        return { id: 1, name: 'test' };
    }
}

export default AuthService;
```
